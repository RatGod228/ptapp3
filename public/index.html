<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProfitTrack</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #f5f5f5; padding: 20px; }
    .box { max-width: 400px; margin: 50px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 20px; color: #333; }
    input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
    button { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; }
    button:hover { background: #45a049; }
    .error { color: red; margin: 10px 0; font-size: 14px; }
    .success { color: green; margin: 10px 0; font-size: 14px; }
    .tabs { display: flex; margin-bottom: 20px; }
    .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-bottom: 2px solid #ddd; }
    .tab.active { border-bottom: 2px solid #4CAF50; color: #4CAF50; font-weight: bold; }
    .link { text-align: center; margin-top: 15px; color: #4CAF50; cursor: pointer; font-size: 14px; }
    .link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const API = window.location.origin + '/api';

    function App() {
      const [page, setPage] = useState('start');
      const [mode, setMode] = useState('login');
      const [err, setErr] = useState('');
      const [ok, setOk] = useState('');
      const [user, setUser] = useState(null);
      
      const [login, setLogin] = useState('');
      const [pass, setPass] = useState('');
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [remail, setRemail] = useState('');
      const [code, setCode] = useState('');
      const [newpass, setNewpass] = useState('');
      const [step, setStep] = useState(1);

      const call = async (url, body) => {
        const r = await fetch(API + url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error);
        return d;
      };

      const doReg = async () => {
        try {
          setErr('');
          const d = await call('/auth/register', { name, login, password: pass, email });
          localStorage.setItem('token', d.token);
          localStorage.setItem('user', JSON.stringify(d.user));
          setUser(d.user);
          setPage('main');
        } catch (e) { setErr(e.message); }
      };

      const doLogin = async () => {
        try {
          setErr('');
          const d = await call('/auth/login', { login, password: pass });
          localStorage.setItem('token', d.token);
          localStorage.setItem('user', JSON.stringify(d.user));
          setUser(d.user);
          setPage('main');
        } catch (e) { setErr(e.message); }
      };

      const doForgot = async () => {
        try {
          setErr('');
          const d = await call('/auth/forgot-password', { email: remail });
          setOk('Код отправлен: ' + d.code);
          setStep(2);
        } catch (e) { setErr(e.message); }
      };

      const doVerify = async () => {
        try {
          setErr('');
          await call('/auth/verify-code', { email: remail, code });
          setOk('');
          setStep(3);
        } catch (e) { setErr(e.message); }
      };

      const doReset = async () => {
        try {
          setErr('');
          await call('/auth/reset-password', { email: remail, code, newPassword: newpass });
          setOk('Пароль изменен!');
          setTimeout(() => { setPage('auth'); setMode('login'); setStep(1); }, 1500);
        } catch (e) { setErr(e.message); }
      };

      const logout = () => {
        localStorage.clear();
        setUser(null);
        setPage('start');
      };

      useEffect(() => {
        const t = localStorage.getItem('token');
        const u = localStorage.getItem('user');
        if (t && u) { setUser(JSON.parse(u)); setPage('main'); }
      }, []);

      if (page === 'start') return (
        <div className="box">
          <h1>ProfitTrack</h1>
          <p style={{textAlign:'center',marginBottom:20}}>Учет закупок и продаж</p>
          <button onClick={() => setPage('auth')}>Начать</button>
        </div>
      );

      if (page === 'auth') return (
        <div className="box">
          <h1>ProfitTrack</h1>
          <div className="tabs">
            <div className={'tab ' + (mode=='login'?'active':'')} onClick={()=>{setMode('login');setErr('')}}>Вход</div>
            <div className={'tab ' + (mode=='register'?'active':'')} onClick={()=>{setMode('register');setErr('')}}>Регистрация</div>
          </div>
          {err && <div className="error">{err}</div>}
          {mode=='login' ? (
            <>
              <input placeholder="Логин" value={login} onChange={e=>setLogin(e.target.value)} />
              <input type="password" placeholder="Пароль" value={pass} onChange={e=>setPass(e.target.value)} />
              <button onClick={doLogin}>Войти</button>
              <div className="link" onClick={()=>setPage('forgot')}>Забыли пароль?</div>
            </>
          ) : (
            <>
              <input placeholder="Имя" value={name} onChange={e=>setName(e.target.value)} />
              <input placeholder="Логин" value={login} onChange={e=>setLogin(e.target.value)} />
              <input placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} />
              <input type="password" placeholder="Пароль" value={pass} onChange={e=>setPass(e.target.value)} />
              <button onClick={doReg}>Зарегистрироваться</button>
            </>
          )}
        </div>
      );

      if (page === 'forgot') return (
        <div className="box">
          <h1>Восстановление</h1>
          {err && <div className="error">{err}</div>}
          {ok && <div className="success">{ok}</div>}
          {step==1 && (
            <>
              <input placeholder="Email" value={remail} onChange={e=>setRemail(e.target.value)} />
              <button onClick={doForgot}>Отправить код</button>
            </>
          )}
          {step==2 && (
            <>
              <input placeholder="Код из письма" value={code} onChange={e=>setCode(e.target.value)} />
              <button onClick={doVerify}>Подтвердить</button>
            </>
          )}
          {step==3 && (
            <>
              <input type="password" placeholder="Новый пароль" value={newpass} onChange={e=>setNewpass(e.target.value)} />
              <button onClick={doReset}>Сменить пароль</button>
            </>
          )}
          <div className="link" onClick={()=>setPage('auth')}>Назад</div>
        </div>
      );

      return (
        <div className="box">
          <h1>Успех!</h1>
          <p style={{textAlign:'center'}}>Привет, {user?.name}!</p>
          <button onClick={logout}>Выйти</button>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
